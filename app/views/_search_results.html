<hr>

<div class="panel panel-default search-results">
  <div class="panel-heading">
    <h3 class="panel-title">Search Results</h3>
  </div>
  <div class="panel-body">

    <% if (photos.length) { %>

      <div style="margin-bottom: 15px;">
        <button id="zipPhotosBtn" class="btn btn-primary" onclick="zipPhotos()">
          <span class="glyphicon glyphicon-compressed"></span> Zip 10 First Photos
        </button>
        <span id="zipStatus" style="margin-left: 10px;"></span>
      </div>

      <% if (downloadLink) { %>
        <div class="alert alert-success" style="margin-bottom: 15px;">
          <strong>Zip available!</strong><br>
          <a href="<%= downloadLink %>" class="btn btn-success" download style="margin-top: 10px;">
            <span class="glyphicon glyphicon-download-alt"></span> Download Zip
          </a>
        </div>
      <% } %>

      <ul>
        <% photos.forEach(function (photo) { %>
          <li class="list-unstyled">
            <a href="<%= photo.media.b %>" class="thumbnail">
              <img src="<%= photo.media.t %>" alt="Photo - <%= photo.title %>"
                title="<%= photo.title %>">
            </a>
          </li>
        <% }) %>
      </ul>

    <% } else { %>
      <div class="alert alert-info"><strong>No results</strong></div>
    <% } %>

  </div>

</div>

<script>
function zipPhotos() {
  const tags = '<%= tagsParameter %>';
  const zipBtn = document.getElementById('zipPhotosBtn');
  const zipStatus = document.getElementById('zipStatus');
  
  // Disable button during request
  zipBtn.disabled = true;
  zipStatus.innerHTML = '<span class="text-info"><span class="glyphicon glyphicon-hourglass"></span> Processing...</span>';
  
  fetch('/zip?tags=' + encodeURIComponent(tags), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    // Check if response is rate limited
    if (response.status === 429) {
      return response.json().then(data => {
        throw new Error(`Rate limit exceeded. Please wait ${data.retryAfter} second(s). Available tokens: ${data.availableTokens}/${data.requiredTokens}`);
      });
    }
    
    // Check for other errors
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || 'Request failed');
      });
    }
    
    return response.json();
  })
  .then(data => {
    zipBtn.disabled = false;
    zipStatus.innerHTML = '<span class="text-success"><span class="glyphicon glyphicon-ok"></span> ' + data.message + '</span>';
    
    // Clear success message after 5 seconds
    setTimeout(() => {
      zipStatus.innerHTML = '';
    }, 5000);
  })
  .catch(error => {
    zipBtn.disabled = false;
    zipStatus.innerHTML = '<span class="text-danger"><span class="glyphicon glyphicon-warning-sign"></span> ' + error.message + '</span>';
    console.error('Error:', error);
    
    // Clear error message after 10 seconds
    setTimeout(() => {
      zipStatus.innerHTML = '';
    }, 10000);
  });
}
</script>
